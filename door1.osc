'##############
'Door Script
'##############

'Controls Doors

'(c) 2007-2009 R�diger H�lsmann
'(c) 2007-2011 Marcel Kuhnt
' 2012 edited for Hamburg (Darius Bode)
' 2015 modified for Chicago (Darius Bode)

'Script Version: 1.1
'Omsi release: 1.0

'Needs:
'- elec

'Revision History:
'- Marcel Kuhnt		13.06.2009	Batterietrennschalter => elec_busbar_main
'- Marcel Kuhnt		21.06.2009	AI-Unterst�tzung hinzugef�gt	
'- R�diger H�lsmann	24.10.2009	Ansteuerung des Kinderwagenwunsches modifiziert
'- R�diger H�lsmann	19.12.2009	Timer f�r Ausstiegst�r jetzt Timegap-basiert, Bugfix: T�r schlie�t jetzt nur bei elec_busbar=1
'- R�diger H�lsmann	22.09.2010	Door light trigger value set to 0.1
'- R�diger H�lsmann	07.11.2010	Door speed based on reservoir pressure, air-operated doors made an option
'- Marcel Kuhnt		08.11.2010	AI procedure closing doors debugged
'- R�diger H�lsmann	21.11.2010	Front doors only operable when busbar on
'- R�diger H�lsmann	23.12.2010	External front door operation included, option: doors only operable with actual stop brake
'- R�diger H�lsmann	31.12.2010	Electric door function debugged
'- R�diger H�lsmann	05.01.2011	20h-switch
'- R�diger H�lsmann	07.01.2011	Backdoor manual switch sound debugged, 20h switch depending on bus type
'- R�diger H�lsmann	19.01.2011	Electric door support
'- Markus Rabe		25.02.2011	D92 Schlie�verhalten der Hintert�r und Einstiegsbeleuchtung ans Vorbild angepasst
'- Markus Rabe		27.02.2011	linker Fl�gel Vordert�r: Abfangeinrichtung eingebaut
'- Marcel Kuhnt		29.06.2011	Integration in Standard-Doorscript
'- Marcel Kuhnt		07.07.2011	Druckluftsimulation inkl. D�mpfer
'- Marcel Kuhnt		09.07.2011	Manuelles �ffnen/Schlie�en
'- Marcel Kuhnt		10.07.2011	Manuelles �ffnen/Schlie�en optimiert
'- Marcel Kuhnt		10.07.2011	Mit westdeutscher T�rsteuerung versehen und f�r O305 erweitert
'- Marcel Kuhnt		10.09.2011	Entriegelte T�ren => Leuchtende T�rlichter
'- Marcel Kuhnt		10.09.2011	Unterschiedliche D�mpfereinstellungen je T�rfl�gel m�glich
'- Darius Bode		2015		Modified for Chicago

'--------------------------------------------------------------------------------

{trigger:cp_doorhandle_drag}

	(L.S.mouse_x) 150 / (L.S.mouse_y) -150 / + (L.L.cp_doorhandle) + -1.75 max 1.75 min (S.L.cp_doorhandle)

{end}

{trigger:cp_doorhandle_off}
	
	(L.L.cp_doorhandle) s0 

		l0 -1 <
			{if}
				-1.5 (S.L.cp_doorhandle)
				(T.L.ev_doorlever4)
			{endif}	
			
		l0 -0.75 < l0 -1 >= &&
			{if}
				-1 (S.L.cp_doorhandle)
				(T.L.ev_doorlever3)
			{endif}
	
		l0 -0.25 < l0 -0.75 >= &&
			{if}
				-0.5 (S.L.cp_doorhandle)
				(T.L.ev_doorlever1)
			{endif}
	
		l0 -0.25 >= l0 0.25 <= &&
			{if}
				0 (S.L.cp_doorhandle)
				(T.L.ev_doorlever2)
			{endif}
		
		l0 0.25 > l0 0.75 <= &&
			{if}
				0.5 (S.L.cp_doorhandle)
				(T.L.ev_doorlever1)
			{endif}

		l0 0.75 > l0 1 <= &&
			{if}
				1 (S.L.cp_doorhandle)
				(T.L.ev_doorlever3)
			{endif}	
			
		l0 1 >
			{if}
				1.5 (S.L.cp_doorhandle)
				(T.L.ev_doorlever4)
			{endif}	
{end}


'Tastaturtrigger Vordertuer

{trigger:bus_doorfront0}

	(L.L.cp_doorhandle) 0.5 = !
		{if}
			0.5 (S.L.cp_doorhandle)
			(T.L.ev_doorlever1)
		{else}
			0 (S.L.cp_doorhandle)
			(T.L.ev_doorlever2)
		{endif}
	
{end}


'Tastaturtrigger Hintertuer

{trigger:bus_doorfront1}

	(L.L.cp_doorhandle) -0.5 = !
		{if}
			-0.5 (S.L.cp_doorhandle)
			(T.L.ev_doorlever1)
		{else}
			0 (S.L.cp_doorhandle)
			(T.L.ev_doorlever2)
		{endif}
	
{end}

{trigger:cp_schalter_kinderwagen}

	(L.L.cp_doorhandle) -1.5 = !
		{if}
			-1.5 (S.L.cp_doorhandle)
			(T.L.ev_doorlever1)
		{else}
			1 (S.L.cp_doorhandle)
			(T.L.ev_doorlever2)
		{endif}
	
{end}

'Tastatur- und AI-Trigger Freigabe

{trigger:bus_dooraft}

	(L.L.cp_doorhandle) 1 = !
		{if}
			1 (S.L.cp_doorhandle)
			(T.L.ev_doorlever1)
		{else}
			0 (S.L.cp_doorhandle)
			(T.L.ev_doorlever2)
		{endif}

{end}

{trigger:int_haltewunsch}
	(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
{end}


{trigger:door_haltewunsch}
	(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
	1 (S.L.door_haltewunsch_knopfdruck)
{end}

{trigger:door_haltewunsch_off}
	0 (S.L.door_haltewunsch_knopfdruck)
{end}

{trigger:door_haltewunsch_cord1}
	(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
	1 (S.L.door_haltewunsch_cord1)
{end}

{trigger:door_haltewunsch_cord1_off}
	0 (S.L.door_haltewunsch_cord1)
{end}

{trigger:door_haltewunsch_cord2}
	(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
	1 (S.L.door_haltewunsch_cord2)
{end}

{trigger:door_haltewunsch_cord2_off}
	0 (S.L.door_haltewunsch_cord2)
{end}

{trigger:door_haltewunsch_cord3}
	(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
	1 (S.L.door_haltewunsch_cord3)
{end}

{trigger:door_haltewunsch_cord3_off}
	0 (S.L.door_haltewunsch_cord3)
{end}


{trigger:door0_drag}
'	(L.L.doorEntriegelung_01)
'	{if}
		(L.S.mouse_x) -2 / (S.L.doorDragAcc_0)
'	{endif}
{end}

{trigger:door1_drag}
'	(L.L.doorEntriegelung_01)
'	{if}
		(L.S.mouse_x) 2 / (S.L.doorDragAcc_1)
'	{endif}
{end}

{trigger:door2_drag}
'	(L.L.doorEntriegelung_23)
'	{if}
		(L.S.mouse_x) -2 / (S.L.doorDragAcc_2)
'	{endif}
{end}

{trigger:door3_drag}
'	(L.L.doorEntriegelung_23)
'	{if}
		(L.S.mouse_x) 2 / (S.L.doorDragAcc_3)
'	{endif}
{end}

{trigger:dooraft_click}
	(L.L.door_2) 0.5 <
		{if}
			1 (S.L.door_2_wunsch)
		{endif}
{end}

{trigger:cp_switch_doormanual}

	(T.L.ev_switch1)
	
	(L.L.cp_switch_doormanual) ! (S.L.cp_switch_doormanual) 	

{end}

{trigger:cp_doorEntriegelung_01}

	(L.L.nothahn_vorn) ! (S.L.nothahn_vorn)
	
	{if} (T.L.ev_nothahn_v_an) {else} (T.L.ev_nothahn_v_aus) {endif}

{end}

{trigger:cp_doorEntriegelung_23}
	
	(L.L.nothahn_hinten) ! (S.L.nothahn_hinten)
	
	{if} (T.L.ev_nothahn_h_an) {else} (T.L.ev_nothahn_h_aus) {endif}

{end}


{trigger:hatch_front}

	(L.L.hatch_1_trans) 0 = 
			{if}
				1 (S.L.hatch_1_trans) 
				(T.L.ev_hatch_front_open)
			{else}
				(L.L.hatch_1_rot) s0 
				
					l0 0 =
					{if}
						1 (S.L.hatch_1_rot)
						(T.L.ev_hatch_front_move)					
					{endif}
					
					l0 1 =
					{if}
						-1 (S.L.hatch_1_rot)
						(T.L.ev_hatch_front_move)					
					{endif}
					
					l0 -1 =
					{if}
						0 (S.L.hatch_1_rot) (S.L.hatch_1_trans)
						(T.L.ev_hatch_front_close)
					{endif}			
			{endif}
			
{end}

{trigger:hatch_rear}

	(L.L.hatch_2_trans) 0 = 
			{if}
				1 (S.L.hatch_2_trans) 
				(T.L.ev_hatch_rear_open)
			{else}
				(L.L.hatch_2_rot) s0 
				
					l0 0 =
					{if}
						1 (S.L.hatch_2_rot)
						(T.L.ev_hatch_rear_move)					
					{endif}
					
					l0 1 =
					{if}
						-1 (S.L.hatch_2_rot)
						(T.L.ev_hatch_rear_move)					
					{endif}
					
					l0 -1 =
					{if}
						0 (S.L.hatch_2_rot) (S.L.hatch_2_trans)
						(T.L.ev_hatch_rear_close)
					{endif}			
			{endif}
			
{end}


{trigger:rampenfummel_drag}
	(L.L.door_0) 1 = (L.L.door_1) 1 = && 
		{if} 
			1 (S.L.rampe_drag)			
			(L.S.mouse_x) 250 / (L.S.mouse_y) -250 / + (L.L.door_rampe_rot) + 0 max 1 min (S.L.door_rampe_rot)			
		{endif}
{end}

{trigger:rampenfummel_off}
	0 (S.L.rampe_drag)
{end}


{macro:Door_Init}
	1000 random 500 / 1 - (C.L.door_acc_var) * (C.L.door0_acc) + (S.L.doorAcc_0)
	1000 random 500 / 1 - (C.L.door_acc_var) * (C.L.door1_acc) + (S.L.doorAcc_1)
	1000 random 1000 / 1 - (C.L.door_acc_var) * (C.L.door2_acc) + (S.L.doorAcc_2)
	1000 random 1000 / 1 - (C.L.door_acc_var) * (C.L.door3_acc) + (S.L.doorAcc_3)
	1000 random 1000 / 1 - (C.L.door_acc_var) * (C.L.door4_acc) + (S.L.doorAcc_4)
	1000 random 1000 / 1 - (C.L.door_acc_var) * (C.L.door5_acc) + (S.L.doorAcc_5)

	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door0_maxspeed) + (S.L.doorMaxSpeed_0_norm)
	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door1_maxspeed) + (S.L.doorMaxSpeed_1_norm)
	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door2_maxspeed) + (S.L.doorMaxSpeed_2_norm)
	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door3_maxspeed) + (S.L.doorMaxSpeed_3_norm)
	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door4_maxspeed) + (S.L.doorMaxSpeed_4_norm)
	1000 random 500 / 1 - (C.L.door_maxspeed_var) * (C.L.door5_maxspeed) + (S.L.doorMaxSpeed_5_norm)
	
'Beim D�mpfer wird der Wert bis auf 40% reduziert statt eine Varianz verwendet:
	900 random 1000 / 0.1 + (C.L.door0_damper) * (S.L.doorDamper_0_kennwert)
	900 random 1000 / 0.1 + (C.L.door1_damper) * (S.L.doorDamper_1_kennwert)
	900 random 1000 / 0.1 + (C.L.door2_damper) * (S.L.doorDamper_2_kennwert)
	900 random 1000 / 0.1 + (C.L.door3_damper) * (S.L.doorDamper_3_kennwert)
	900 random 1000 / 0.1 + (C.L.door4_damper) * (S.L.doorDamper_4_kennwert)
	900 random 1000 / 0.1 + (C.L.door5_damper) * (S.L.doorDamper_5_kennwert)
	
	(C.L.door_refl) (S.L.doorRefl_0)
	(C.L.door_refl) (S.L.doorRefl_1)
	(C.L.door_refl) (S.L.doorRefl_2)
	(C.L.door_refl) (S.L.doorRefl_3)
	(C.L.door_refl) (S.L.doorRefl_4)
	(C.L.door_refl) (S.L.doorRefl_5)

	0 (S.L.door0_warten)
	0 (S.L.door0_umkehr)	

	0 (S.L.door0_physblock)
	1 (S.L.door1_physblock)

	0 (S.L.door_pressure_open_0)
	1 (S.L.door_pressure_close_0)
{end}

{macro:Door_Frame}


'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''			
			
	(M.L.Door0_Calc)
	(M.L.Door1_Calc)
	(M.L.DoorAftCalc)
	(M.L.Door2_Calc)
	(M.L.Door3_Calc)
'	(M.L.Door4_Calc)
'	(M.L.Door5_Calc)

	0
	(S.L.doorDragAcc_0)
	(S.L.doorDragAcc_1)
	(S.L.doorDragAcc_2)
	(S.L.doorDragAcc_3)
	(S.L.doorDragAcc_4)
	(S.L.doorDragAcc_5)
	
'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''			


'	Entriegelung

	(L.L.nothahn_vorn) (L.L.cp_switch_doormanual) ||
	(L.L.cp_switch_main_rot_set) 0.33 < ||
		{if}
		
			(L.L.doorEntriegelung_01) ! 
				{if}
					(T.L.ev_doorEntriegelung_01_on)
					1 (S.L.doorEntriegelung_01)			
				{endif}	
		
		{endif}
		
	(L.L.nothahn_hinten) (L.L.cp_switch_doormanual) ||
	(L.L.cp_switch_main_rot_set) 0.33 < ||
		{if}
		
			(L.L.doorEntriegelung_23) ! 
				{if}					
					1 (S.L.doorEntriegelung_23)	
					
'	HINTERTUER SOLO = ELEKTRISCH	
'					(L.L.nothahn_hinten)
'						{if}
'							(T.L.ev_doorEntriegelung_23_on)
'						{endif}
				{endif}	
		
		{endif}	
		
	(L.L.nothahn_vorn) ! (L.L.cp_switch_doormanual) ! &&
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
		{if}
		
			(L.L.doorEntriegelung_01)
				{if}
					0 (S.L.doorEntriegelung_01)
					(T.L.ev_doorEntriegelung_01_off)
						(C.L.door_druckluft)
							{if}
								(L.L.bremse_p_Tank04) 100000 - 0.94 * 100000 + (S.L.bremse_p_Tank04)
							{endif}
				{endif}
				
		{endif}
		
	(L.L.nothahn_hinten) ! (L.L.cp_switch_doormanual) ! &&
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
		{if}
		
			(L.L.doorEntriegelung_23)
				{if}
					0 (S.L.doorEntriegelung_23)
'					(T.L.ev_doorEntriegelung_23_off)
'	HINTERTUER SOLO = ELEKTRISCH					
'						(C.L.door_druckluft)
'							{if}
'								(L.L.bremse_p_Tank04) 100000 - 0.94 * 100000 + (S.L.bremse_p_Tank04)
'							{endif}
				{endif}
				
		{endif}	

'	Tuer-Oberlichter

	(L.L.cp_switch_main_rot_set) 0.66 >=
		{if}
			(L.L.door_0) 0.05 >
				{if}
					
					(L.L.door_oberlicht1_lichtreq) !
						{if}
							(L.L.globaltimer) (S.L.door_oberlicht1_lichtreq_zeit)
							1 (S.L.door_oberlicht1_lichtreq)
						{endif}
						
				{else}

					(L.L.door_oberlicht1_lichtreq)
						{if}
							(L.L.globaltimer) (S.L.door_oberlicht1_lichtreq_zeit)
							0 (S.L.door_oberlicht1_lichtreq)
						{endif}
						
				{endif}
								
			(L.L.door_2) 0.05 > (L.L.door_freigabe) &&
				{if}
					
					(L.L.door_oberlicht2_lichtreq) !
						{if}
							(L.L.globaltimer) (S.L.door_oberlicht2_lichtreq_zeit)
							1 (S.L.door_oberlicht2_lichtreq)
						{endif}
				{endif}	
				
			(L.L.door_2) 0.05 <=
				{if}	
					(L.L.door_oberlicht2_lichtreq)
						{if}
							(L.L.globaltimer) (S.L.door_oberlicht2_lichtreq_zeit)
							0 (S.L.door_oberlicht2_lichtreq)
						{endif}					
															
				{endif}	

		{else}
			0 (S.L.door_oberlicht1_lichtreq) (S.L.door_oberlicht2_lichtreq)
		{endif}
		
		(L.L.door_oberlicht1_lichtreq) (L.L.door_oberlicht1) ! &&
		(L.L.globaltimer) (L.L.door_oberlicht1_lichtreq_zeit) 0.5 + > &&
			{if}
				1 (S.L.door_oberlicht1)
				0 (S.L.door_oberlicht1_lichtreq_zeit)
			{endif}
			
		(L.L.door_oberlicht1_lichtreq) ! (L.L.door_oberlicht1) &&
		(L.L.globaltimer) (L.L.door_oberlicht1_lichtreq_zeit) 1 + > && 
			{if}
				0 (S.L.door_oberlicht1)
				0 (S.L.door_oberlicht1_lichtreq_zeit)
			{endif}	
			
		(L.L.door_oberlicht2_lichtreq) (L.L.door_oberlicht2) ! &&
		(L.L.globaltimer) (L.L.door_oberlicht2_lichtreq_zeit) 0.5 + > &&
			{if}
				1 (S.L.door_oberlicht2)
				0 (S.L.door_oberlicht2_lichtreq_zeit)
			{endif}
			
		(L.L.door_oberlicht2_lichtreq) ! (L.L.door_oberlicht2) &&
		(L.L.globaltimer) (L.L.door_oberlicht2_lichtreq_zeit) 1 + > && 
			{if}
				0 (S.L.door_oberlicht2)
				0 (S.L.door_oberlicht2_lichtreq_zeit)
			{endif}		
		
					
	(L.L.new_lights_set)
		{if}
			(L.L.door_oberlicht1) (L.L.lights_fahrerlicht) || (S.L.lights_fahrerlicht_LED)
			(L.L.door_oberlicht1) (S.L.door_oberlicht1_LED)
			(L.L.door_oberlicht2) (S.L.door_oberlicht2_LED) 			
		{else}
			(L.L.door_oberlicht1) (S.L.door_oberlicht1_bulb)
			(L.L.door_oberlicht2) (S.L.door_oberlicht2_bulb) 
		{endif}	
		
	
'	Anforderung mit neuen Variablen:

	(L.L.haltewunsch)   (L.L.PAX_Exit0_Req) || (S.L.haltewunsch)
	(L.L.haltewunsch_2) (L.L.PAX_Exit1_Req) || (S.L.haltewunsch_2)	
	
	
'	"Dauerfeuer"-Haltewunsch

	(L.L.door_haltewunsch_knopfdruck)
	{if}
		(L.L.door_freigabe) ! {if} 1 (S.L.haltewunsch) {endif}
	{endif}

'	Ausgabe Tuerwerte

	(L.L.door_0) 0.8 >
	(L.L.door_1) 0.8 > &&
	(L.L.door_rampe_rot) ! &&
	(L.L.clever_on) &&
		{if}
			1 (S.L.PAX_Entry0_Open)
			1 (S.L.PAX_Exit1_Open)
		{else}
			0 (S.L.PAX_Entry0_Open)
			0 (S.L.PAX_Exit1_Open)
		{endif}
		
	(L.L.door_2) 0.4 >
	(L.L.door_3) 0.4 > &&
		{if}
			1 (S.L.PAX_Exit0_Open)
			1 (S.L.PAX_Entry1_Open)
		{else}
			0 (S.L.PAX_Exit0_Open)
			0 (S.L.PAX_Entry1_Open)
		{endif}	
	
'	Tuertaster werden von Fahrg�sten benutzt:

	(L.L.PAX_Exit0_Req)
		{if}
			1 (S.L.door_2_wunsch)
		{endif}
	
	(L.L.door_2) 1 =
		{if}
			0 (S.L.door_2_wunsch)
		{endif}

		
'	Steuerhebel

	(L.L.cp_switch_main_rot_set) 0.33 >=
		{if}
			(L.L.cp_doorhandle) s0
				
				l0 0 = 
					{if} 
						(L.L.door_freigabe) {if} (T.L.ev_door_freigabe_cls) {endif}
						0 (S.L.door_freigabe) 
						
						(L.L.doorTarget_0)
						(L.L.doorEntriegelung_01) ! &&
						(L.L.bremse_p_Tank04) 500000 > &&
							{if}				
								(M.L.trg_bus_doorfront0)
								(M.L.trg_bus_doorfront1)
							{endif}

					{endif}
					
				l0 0.5 =
					{if} 
						(L.L.door_freigabe) {if} (T.L.ev_door_freigabe_cls) {endif}
						0 (S.L.door_freigabe) 
						
						(L.L.doorTarget_0) !
						(L.L.doorEntriegelung_01) ! &&
						(L.L.bremse_p_Tank04) 500000 > &&
							{if}				
								(M.L.trg_bus_doorfront0)
								(M.L.trg_bus_doorfront1)
							{endif}

					{endif}
					
				l0 -0.5 =
					{if} 
						
					1 (S.L.door_freigabe) 
						
					(L.L.doorTarget_0)
					(L.L.doorEntriegelung_01) ! &&
					(L.L.bremse_p_Tank04) 500000 > &&
						{if}				
							(M.L.trg_bus_doorfront0)
							(M.L.trg_bus_doorfront1)
						{endif}
					{endif}	
					
				l0 1 = l0 -1 = ||
					{if} 
					1 (S.L.door_freigabe) 
						
					(L.L.doorTarget_0) !
					(L.L.doorEntriegelung_01) ! &&
					(L.L.bremse_p_Tank04) 500000 > &&
						{if}				
						(M.L.trg_bus_doorfront0)
						(M.L.trg_bus_doorfront1)
						{endif}
					{endif}		
			
		
				l0 1.5 = l0 -1.5 = ||
					{if} 
					(L.L.door_freigabe) ! {if} (T.L.ev_door_freigabe_opn) {endif}
					1 (S.L.door_freigabe) (S.L.door_2_wunsch)
						
					(L.L.doorTarget_0) !
					(L.L.doorEntriegelung_01) ! &&
					(L.L.bremse_p_Tank04) 500000 > &&
						{if}				
							(M.L.trg_bus_doorfront0)
							(M.L.trg_bus_doorfront1)
						{endif}
					{endif}		
		{endif}
		
'	Anhand dieser Bedingungen kann nun die Automatikt�r ge�ffnet werden:

'	Freigabe
	(L.L.door_freigabe)
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
	(L.L.Velocity) 0.1 < &&
		{if}
			(L.L.door_2_wunsch) (L.L.door_3) 0.2 < &&
				{if}
					(M.L.DoorAft_Open)
					0 (S.L.door_2_wunsch)
				{endif}			
		{endif}
		
'	Freigabelicht
	(L.L.cp_switch_main_rot_set) 0.33 >=
	(L.L.door_freigabe) &&
	(L.L.Velocity) 0.1 <= &&
	(L.L.Velocity) -0.1 >= &&
		{if}
			1 (S.L.door_freigabe_licht)
		{else}
			0 (S.L.door_freigabe_licht)
		{endif}

'	Rear Door Sound
	
	(L.L.door_freigabe_licht)
	(L.L.rear_door_sound) ! &&
		{if}
			1 (S.L.rear_door_sound)
			(T.L.ev_door_freigabe_opn)
		{else}
		(L.L.door_freigabe_licht) !
			{if}
				0 (S.L.rear_door_sound)
			{endif}
		{endif}

'	Drunk alert:
	(L.L.door_2) 0.03 > (L.L.door_3) 0.03 > ||
	(L.L.door_freigabe) ! (L.L.Velocity) 10 > || &&	
	(L.L.rear_door_active) ! &&
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
	(L.L.drunk_alarm_arm) &&
		{if}
			1 (S.L.drunk_alarm)
		{else}
			0 (S.L.drunk_alarm)
		{endif}
		
	(L.L.door_2) 0 = (L.L.door_3) 0 = &&	
		{if}
			1 (S.L.drunk_alarm_arm)
		{endif}
		
	(L.L.door_2) 0.03 > (L.L.door_3) 0.03 > ||
	(L.L.drunk_alarm) ! &&
		{if}
			0 (S.L.drunk_alarm_arm)
		{endif}	
		
'	Haltewunschlampe:
		
	(L.L.haltewunsch) ! (L.L.haltewunsch_2) ! &&
	(L.L.door_0) 0 > ||
	(L.L.door_1) 0 > ||
	(L.L.door_2) 0 > ||
	(L.L.door_3) 0 > ||
	(L.L.door_4) 0 > ||	
	(L.L.door_5) 0 > ||
		{if}	
			0 (S.L.haltewunschlampe) (S.L.haltewunsch) (S.L.haltewunsch_2) (S.L.prev_haltewunsch) (S.L.missed_stop)
		{endif}

	(L.L.haltewunsch) (L.L.haltewunsch_2) ||
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
	(L.L.door_0) ! &&
	(L.L.door_1) ! &&
	(L.L.door_2) ! &&
	(L.L.door_3) ! &&
	(L.L.door_4) ! &&	
	(L.L.door_5) ! &&
	(L.L.haltewunschlampe) ! &&
		{if}
			(C.L.display_change_sec) 0.05 + (S.L.clever_LED_time)
			1 (S.L.stop_request_trig)
			1 (S.L.clever_LED_mode)
			1 (S.L.haltewunschlampe)
			
			(L.L.humans_count) 0 >
			(L.L.schedule_active) &&
			(L.L.missed_stop) ! &&
			(M.V.GetTTBusstopIndex) s0 0 > &&			
				{if}
					
					(L.L.missed_stop_pre) l0 =
						{if}
							l0 1 + (S.L.missed_stop)
						{else}
							l0 (S.L.missed_stop)
						{endif}			
					
				{endif}			
			
		{endif}

	
'	Missed Stop:

	(L.L.door_0) 0 > (L.L.door_2) 0 > ||
		{if}
			(M.V.GetTTBusstopIndex) (S.L.missed_stop_pre) 
		{endif}
		
	(M.V.GetTTBusstopIndex) (L.L.missed_stop_pre) 1 + >	
	(L.L.haltewunschlampe) ! &&
		{if}
			(M.V.GetTTBusstopIndex) (S.L.missed_stop_pre) 
		{endif}	
	
	(L.L.humans_count) 0 <= (L.L.schedule_active) ! ||
		{if}
			0 (S.L.missed_stop)
		{endif}		
				
	(M.V.GetTTBusstopIndex) (L.L.missed_stop) > (L.L.humans_count) 0 > &&
	(L.L.missed_stop) 0 > &&
		{if}
			0 18 random s0
				l0 0 <= {if} (T.L.ev_missed_stop_1) {endif}
				l0 1 = {if} (T.L.ev_missed_stop_2) {endif}
				l0 2 = {if} (T.L.ev_missed_stop_3) {endif}
				l0 3 = {if} (T.L.ev_missed_stop_4) {endif}
				l0 4 = {if} (T.L.ev_missed_stop_5) {endif}
				l0 5 = {if} (T.L.ev_missed_stop_6) {endif}
				l0 6 = {if} (T.L.ev_missed_stop_7) {endif}
				l0 7 = {if} (T.L.ev_missed_stop_8) {endif}
				l0 8 = {if} (T.L.ev_missed_stop_9) {endif}
				l0 9 = {if} (T.L.ev_missed_stop_10) {endif}
				l0 10 = {if} (T.L.ev_missed_stop_11) {endif}
				l0 11 = {if} (T.L.ev_missed_stop_12) {endif}
				l0 12 = {if} (T.L.ev_missed_stop_13) {endif}
				l0 13 = {if} (T.L.ev_missed_stop_14) {endif}
				l0 14 = {if} (T.L.ev_missed_stop_15) {endif}
				l0 15 = {if} (T.L.ev_missed_stop_16) {endif}
				l0 16 = {if} (T.L.ev_missed_stop_17) {endif}
				l0 17 = {if} (T.L.ev_missed_stop_18) {endif}
				l0 18 >= {if} (T.L.ev_missed_stop_19) {endif}
			0 (S.L.missed_stop)
		{endif}

	(L.S.Day) 14 =	
	(L.S.Month) 9 = &&
	(L.S.Time) 39600 > &&
	(L.S.Time) 54000 < &&
	(L.L.missed_stop_random) ! &&
	(L.L.door_0) 0 = (L.L.door_2) 0 = && &&
	(L.L.humans_count) 0 > &&
		{if}
			1 (S.L.missed_stop_random)
			0 3 random s0
			l0 0 <= {if} (T.L.ev_random_1) {endif}
			l0 1 = {if} (T.L.ev_random_2) {endif}
			l0 2 >= {if} (T.L.ev_random_3) {endif}
		{endif}	
		
	(L.L.door_0) 0.5 >
	(L.L.door_2) 0.5 > ||
		{if}
			0 (S.L.missed_stop_random)
		{endif}
		
'	Bing:
	(L.L.haltewunsch)
	(L.L.haltewunsch_2) ||
	(L.L.door_kinderwagenwunsch) || 
	(L.L.prev_haltewunsch) ! &&
	(L.L.cp_switch_main_rot_set) 0.33 >= &&
	(L.L.door_0) ! && 
	(L.L.door_1) ! && 
	(L.L.door_2) ! && 
	(L.L.door_3) ! && 
	(L.L.door_4) ! &&
	(L.L.door_5) ! &&
		{if}
			(T.L.ev_stop)
		{endif}
		
	(L.L.haltewunsch) (L.L.haltewunsch_2) (L.L.door_kinderwagenwunsch) || || (S.L.prev_haltewunsch)			

'	Abfall des Relais bei fehlender Stromversorgung:
	(L.L.cp_switch_main_rot_set) 0.33 < (L.L.elec_failure_general) ||
	{if}
		0 (S.L.door_kinderwagenwunsch) (S.L.door_kinderwagen) (S.L.haltewunschlampe) (S.L.haltewunsch) (S.L.haltewunsch_2) (S.L.rampenwunsch) 
	{endif}
	
		

'###############################################################################################
'	Druckluftverhalten:

(C.L.door_druckluft)
{if}

' in s6 ist die verf�gbare Druckmenge:
	(L.L.bremse_p_Tank04) 100000 - 850000 / s6

'-------------------------------------------------------------------


' Zun�chst die T�rentriegelungen:

	(L.L.doorEntriegelung_01)
	{if}
'T�r ist entl�ftet:
		-2 (S.L.doorEntriegelung_doorActive_01)
	{else}
	(C.L.door_safe_reactivating) !
	{if}
'T�r steht unter Druck:
		1 (S.L.doorEntriegelung_doorActive_01)
	{else}
	(L.L.doorEntriegelung_doorActive_01) -2 =
	{if}
'T�r ist "vorbereitet":
		-1 (S.L.doorEntriegelung_doorActive_01)
	{endif}
	{endif}
	{endif}



	(L.L.doorEntriegelung_23)
	{if}
'T�r ist entl�ftet:
		-2 (S.L.doorEntriegelung_doorActive_23)
	{else}
	(C.L.door_safe_reactivating) !
	{if}
'T�r steht unter Druck:
		1 (S.L.doorEntriegelung_doorActive_23)
	{else}
	(L.L.doorEntriegelung_doorActive_23) -2 =
	{if}
'T�r ist "vorbereitet":
		-1 (S.L.doorEntriegelung_doorActive_23)
	{endif}
	{endif}
	{endif}




	(L.L.doorEntriegelung_45)
	{if}
'T�r ist entl�ftet:
		-2 (S.L.doorEntriegelung_doorActive_45)
	{else}
	(C.L.door_safe_reactivating) !
	{if}
'T�r steht unter Druck:
		1 (S.L.doorEntriegelung_doorActive_45)
	{else}
	(L.L.doorEntriegelung_doorActive_45) -2 =
	{if}
'T�r ist "vorbereitet":
		-1 (S.L.doorEntriegelung_doorActive_45)
	{endif}
	{endif}
	{endif}

'-------------------------------------------------------------------

'Druck laaaaangsam aufbauen (sofern n�tig):

	(L.L.doorEntriegelung_doorActive_01) s1 0 >= l1 0.99 < &&
	{if}
		1 s0 0.1 s2 s3 (M.L.traegheit) (S.L.doorEntriegelung_doorActive_01)
		(L.L.doorEntriegelung_doorActive_01) 0.8 >
		{if}
			(T.L.ev_doorEntriegelung_01_off_final)
			1 (S.L.doorEntriegelung_doorActive_01)
		{endif}
	{endif}

	(L.L.doorEntriegelung_doorActive_23) s1 0 >= l1 0.99 < &&
	{if}
		1 s0 0.1 s2 s3 (M.L.traegheit) (S.L.doorEntriegelung_doorActive_23)
		(L.L.doorEntriegelung_doorActive_23) 0.8 >
		{if}
			(T.L.ev_doorEntriegelung_23_off_final)
			1 (S.L.doorEntriegelung_doorActive_23)
		{endif}
	{endif}

	(L.L.doorEntriegelung_doorActive_45) s1 0 >= l1 0.99 < &&
	{if}
		1 s0 0.1 s2 s3 (M.L.traegheit) (S.L.doorEntriegelung_doorActive_45)
		(L.L.doorEntriegelung_doorActive_45) 0.8 >
		{if}
			(T.L.ev_doorEntriegelung_45_off_final)
			1 (S.L.doorEntriegelung_doorActive_45)
		{endif}
	{endif}


'-------------------------------------------------------------------


	(L.L.doorEntriegelung_doorActive_01) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_0) ! s5 !
	{endif}

	(L.L.doorEntriegelung_doorActive_01) l6 * * s0
	(L.L.door_pressure_open_0) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_0)

	(L.L.door_pressure_close_0) s1
	l5 (L.L.doorEntriegelung_doorActive_01) l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_0)

'.....................

	(L.L.doorEntriegelung_doorActive_01) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_1) ! s5 !
	{endif}

	l6 (L.L.doorEntriegelung_doorActive_01) * * s0
	(L.L.door_pressure_open_1) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_1)

	(L.L.door_pressure_close_1) s1
	l5 (L.L.doorEntriegelung_doorActive_01) l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_1)

'.....................

	(L.L.doorEntriegelung_doorActive_23) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_23) ! s5 !
	{endif}

	(L.L.doorEntriegelung_doorActive_23) l6 * * s0
	(L.L.door_pressure_open_2) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_2)

	(L.L.door_pressure_close_2) s1
	(L.L.doorEntriegelung_doorActive_23) l5 l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_2)

'.....................

	(L.L.doorEntriegelung_doorActive_23) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_23) ! s5 !
	{endif}

	(L.L.doorEntriegelung_doorActive_23) l6 * * s0
	(L.L.door_pressure_open_3) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_3)

	(L.L.door_pressure_close_3) s1
	(L.L.doorEntriegelung_doorActive_23) l5 l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_3)

'.....................

	(L.L.doorEntriegelung_doorActive_45) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_45) ! s5 !
	{endif}

	(L.L.doorEntriegelung_doorActive_45) l6 * * s0
	(L.L.door_pressure_open_4) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_4)

	(L.L.door_pressure_close_4) s1
	(L.L.doorEntriegelung_doorActive_45) l5 l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_4)

'.....................

	(L.L.doorEntriegelung_doorActive_45) 0 <=
	{if}
		0 s5
	{else}
		(L.L.doorTarget_45) ! s5 !
	{endif}

	(L.L.doorEntriegelung_doorActive_45) l6 * * s0
	(L.L.door_pressure_open_5) s1
	1 s2 1 s3
	(M.L.traegheit) (S.L.door_pressure_open_5)

	(L.L.door_pressure_close_5) s1
	(L.L.doorEntriegelung_doorActive_45) l5 l6 * * s0
	(M.L.traegheit) (S.L.door_pressure_close_5)

'.....................

	l6 (L.L.doorEntriegelung_doorActive_01) 0 max * (S.L.door_pressure_factor_01)
	l6 (L.L.doorEntriegelung_doorActive_23) 0 max * (S.L.door_pressure_factor_23)
	l6 (L.L.doorEntriegelung_doorActive_45) 0 max * (S.L.door_pressure_factor_45)

{endif}

'###############################################################################################
' D�mpferverhalten:

	(L.L.doorSpeed_0) 0 >
	{if}
		(L.L.door_0) (F.L.damper_f_open)
	{else}
		(L.L.door_0) (F.L.damper_f_close)
	{endif}
	(L.L.doorSpeed_0) * s0

	(L.L.doorEntriegelung_01)
	{if}
		l0
	{else}
		(L.L.doorDamper_0) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_0)

'........................

	(L.L.doorSpeed_1) 0 >
	{if}
		(L.L.door_1) (F.L.damper_f_open)
	{else}
		(L.L.door_1) (F.L.damper_f_close)
	{endif}
	(L.L.doorSpeed_1) * s0

	(L.L.doorEntriegelung_01)
	{if}
		l0
	{else}
		(L.L.doorDamper_1) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_1)

'........................

	(L.L.doorSpeed_2) 0 >
	{if}
		(L.L.door_2) (F.L.damper_m_open)
	{else}
		(L.L.door_2) (F.L.damper_m_close)
	{endif}
	(L.L.doorSpeed_2) * s0

	(L.L.doorEntriegelung_23)
	{if}
		l0
	{else}
		(L.L.doorDamper_2) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_2)

'........................

	(L.L.doorSpeed_3) 0 >
	{if}
		(L.L.door_3) (F.L.damper_m_open)
	{else}
		(L.L.door_3) (F.L.damper_m_close)
	{endif}
	(L.L.doorSpeed_3) * s0

	(L.L.doorEntriegelung_23)
	{if}
		l0
	{else}
		(L.L.doorDamper_3) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_3)

'........................

	(L.L.doorSpeed_4) 0 >
	{if}
		(L.L.door_4) (F.L.damper_b_open)
	{else}
		(L.L.door_4) (F.L.damper_b_close)
	{endif}
	(L.L.doorSpeed_4) * s0

	(L.L.doorEntriegelung_45)
	{if}
		l0
	{else}
		(L.L.doorDamper_4) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_4)

'........................

	(L.L.doorSpeed_5) 0 >
	{if}
		(L.L.door_5) (F.L.damper_b_open)
	{else}
		(L.L.door_5) (F.L.damper_b_close)
	{endif}
	(L.L.doorSpeed_5) * s0

	(L.L.doorEntriegelung_45)
	{if}
		l0
	{else}
		(L.L.doorDamper_5) s1
		3 s2 3 s3
		(M.L.traegheit)
	{endif}
	(S.L.doorDamper_5)


'###############################################################################################
'	Gegenseitiges Blockieren der T�rfl�gel:

'	Die jeweilige T�r wird dadurch blockiert, dass ihr �ffnungsgrad kleiner ist als der des anderen Fl�gels ist, der selbst aber schon fast zu und nicht blockiert sein muss:

	(C.L.door_blocking) 
	{if}

		(L.L.door0_physblock)
		{if}
			(L.L.door_0) (L.L.door_1) (C.L.door_blocking_diff) + < (L.L.door_1) (C.L.door_blocking_area) < && (L.L.door1_physblock) ! && (S.L.door0_physblock)
		{else}
			(L.L.door_0) (L.L.door_1) < (L.L.door_1) (C.L.door_blocking_area) < && (L.L.door1_physblock) ! && (S.L.door0_physblock)
		{endif}

		(L.L.door1_physblock)
		{if}
			(L.L.door_1) (L.L.door_0) (C.L.door_blocking_diff) + < (L.L.door_0) (C.L.door_blocking_area) < && (L.L.door0_physblock) ! && (S.L.door1_physblock)
		{else}
			(L.L.door_1) (L.L.door_0) < (L.L.door_0) (C.L.door_blocking_area) < && (L.L.door0_physblock) ! && (S.L.door1_physblock)
		{endif}
	{else}
		0 (S.L.door0_physblock) (S.L.door1_physblock)
	{endif}

'###############################################################################################
'###############################################################################################		

'	Debug fuer Anfahrsperre (damit nach ge�ffnetem und wieder geschlossenem Nothahn die Anfahrsperre nicht ausl�st)
	(L.L.doorEntriegelung_23) !
	(L.L.doorEntriegelung_23wait) &&
	(L.L.door_2) 0 = &&
	(L.L.door_3) 0 = || &&
	(L.L.Velocity) 0 > &&
	{if}
		0 (S.L.doorEntriegelung_23wait)
	{endif}
	
	(L.L.doorEntriegelung_45) !
	(L.L.doorEntriegelung_45wait) &&
	(L.L.door_4) 0 = &&
	(L.L.door_5) 0 = &&
	(L.L.Velocity) 0 > &&
	{if}
		0 (S.L.doorEntriegelung_45wait)
	{endif}
	
' 	Anfahrsperre Sicherheitsfunktion
	(L.L.globaltimer) (L.L.cockpit_schluesselzeit) 2.5 + <
	(L.L.bremse_halte) ! (L.L.antrieb_getr_aktugang) 0 = && (L.L.Brake) 0.1 < && (L.L.antrieb_getr_gangwahl) 1 = && ||
	(L.L.engine_injection_on) ! &&
	(L.L.elec_busbar_main) &&
		{if}
			1 (S.L.bremse_anfahrsperre_safe)
		{endif}
	
	(L.L.engine_injection_on) (L.L.Throttle) 0.05 > &&
		{if}
			0 (S.L.bremse_anfahrsperre_safe)
		{endif}		
		
'	Automatische Standbremse
	(L.L.Velocity) 0.3 >=
		{if}
			1 (S.L.stopbrake_prep)
		{endif}
		
	(L.L.Throttle) 0.1 > (L.L.Velocity) 0.1 <= &&
		{if}
			0 (S.L.stopbrake_prep)
		{endif}
	
' 	Anfahrsperre	

	(L.L.door_2) 0.2 >
	(L.L.door_3) 0.2 > ||
	(L.L.doorEntriegelung_23) ! &&	
	(L.L.door_freigabe) ||
	(L.L.kneeling) ||
	(L.L.cp_doorhandle) 0 = ! &&	
	(L.L.door_rampe_rot) 0 = ! ||
'	(L.L.knickschutz_aktiv) (L.L.antrieb_getr_gangwahl) 0 = (L.L.engine_injection_on) && && ||
	(L.L.cp_notloese_anfahrsperre) ! &&
	(L.L.bremse_halte) ! &&	
	(L.L.bremse_anfahrsperre_safe) || 
	(L.L.stopbrake_prep) (L.L.Velocity) 0.1 <= && ||
	(L.L.elec_busbar_main) &&
		{if}
			1 (S.L.bremse_anfahrsperre)
		{endif}
		
	(L.L.door_2) 0 =
	(L.L.door_3) 0 = &&	
	(L.L.doorEntriegelung_23) ||
	(L.L.door_freigabe) ! &&
	(L.L.cp_doorhandle) 0 = ||
	(L.L.globaltimer) (L.L.door_time) 1.5 + > &&	
	(L.L.door_rampe_rot) ! &&
	(L.L.kneeling) ! &&
	(L.L.kneeling_down) ! &&
	(L.L.bremse_anfahrsperre) &&	
'	(L.L.knickschutz_aktiv)	! (L.L.antrieb_getr_gangwahl) 0 = ! (L.L.engine_injection_on) ! || || &&
	(L.L.bremse_anfahrsperre_safe) ! (L.L.cp_notloese_anfahrsperre) || &&
	(L.L.stopbrake_prep) ! (L.L.Velocity) 0.3 > || &&
	(L.L.elec_busbar_main) ! ||
		{if}		
			0 (S.L.bremse_anfahrsperre)	
		{endif}

		
'	W/C RAMP

	(L.L.elec_busbar_main)
	(L.L.bremse_feststell) &&
	(L.L.engine_injection_on) &&
	(L.L.Throttle) 0.05 < &&
	(L.L.door_0) 1 = (L.L.door_1) 1 = && &&
	(L.L.door_rampe_rot) 0 > ||
		{if}
				
				(L.L.cp_switch_ramp_set) s0

'				DEPLOY				
					l0 0 <
						{if}
							
							(L.L.door_rampe_rot) (L.S.Timegap) 9 / + (S.L.door_rampe_rot)
													
							(L.L.door_rampe_rot) 1 (L.L.door_rampe_height) + >
								{if}
									1 (L.L.door_rampe_height) + (S.L.door_rampe_rot)
									0 (S.L.ramp_travel)	(S.L.ramp_dir)								
								{else}
									1 (S.L.ramp_travel) (S.L.ramp_dir)
								{endif}
							
						{endif}

'				FLOAT						
					l0 0 =
						{if}						
							
							0 (S.L.ramp_travel)
						
							(L.L.door_rampe_rot) 0.495 >=
								{if}
								
									(L.L.door_rampe_rot) (L.S.Timegap) 25 / (L.L.door_rampe_rot) 20 * *  + (S.L.door_rampe_rot)
							
									1 (L.L.door_rampe_height) + >
										{if}
											1 (L.L.door_rampe_height) + (S.L.door_rampe_rot)
											0 (S.L.ramp_dir)
										{else}
											1 (S.L.ramp_dir)
										{endif}
								
								{else}
								
									(L.L.door_rampe_rot) (L.S.Timegap) 25 / 1 (L.L.door_rampe_rot) - * 20 * - (S.L.door_rampe_rot)

									
									(L.L.door_rampe_rot) 0 <
										{if}
											0 (S.L.door_rampe_rot) (S.L.ramp_dir)
										{else}
											-1 (S.L.ramp_dir)
										{endif}
								
								{endif}
							
						{endif}	

'				STOW						
					l0 0 >
						{if}
							
							(L.L.door_rampe_rot) (L.S.Timegap) 9 / - (S.L.door_rampe_rot)
							
							(L.L.door_rampe_rot) 0 <
								{if}
									0 (S.L.door_rampe_rot)
									0 (S.L.ramp_travel) (S.L.ramp_dir)
								{else}
									1 (S.L.ramp_travel)
									-1 (S.L.ramp_dir)
								{endif}
						
						{endif}	
				
		{endif}

'	Sound Rampe

	(L.L.ramp_dir) (L.L.ramp_dir_last) = !
		{if}
			
			(L.L.ramp_dir) 1 = (L.L.ramp_dir) -1 = ||
				{if}
					(T.L.ev_ramp_start)
				{endif}
			
			(L.L.ramp_dir) 0 =
				{if}
					(T.L.ev_ramp_end)
				{endif}
				
			(L.L.ramp_dir) (S.L.ramp_dir_last)	
			
		{endif}

	
'	Hoehe Rampe

	 (L.L.door_rampe_rot) 0 = !
		{if}
			2.379	5.509	0	(M.V.GetHeightAbovePoint) (F.L.door_handrampe_height) (S.L.door_rampe_height)
		{else}
			0 (S.L.door_rampe_height)
		{endif}
		
		

{end}





'###############################################################################################
'###############################################################################################
' Door Calc T�renpaar 1
'###############################################################################################


{macro:Door0_Calc}
		(C.L.electric_doors) (L.L.doorEntriegelung_E_active_01) ! &&
		{if}
			(L.L.doorEntriegelung_doorActive_01)
			{if}

			(L.L.doorTarget_0)
			{if}
				(L.L.door_0) (F.L.door_0_opn_speed) (S.L.doorMaxSpeed_0)
			{else}
				(L.L.door_0) (F.L.door_0_cls_speed) (S.L.doorMaxSpeed_0)
			{endif}

			(C.L.door0_acc) (S.L.doorAcc_0)

			(L.L.doorTarget_0) ! (L.L.doorSpeed_0) s0 abs 0.05 > (L.L.door_0) 0 > || && 
			{if}
				(C.L.thinking_doors)
				{if}
					(L.L.doorTarget_1) !
					(L.L.door_1) 0 > &&
					(L.L.door_1) (L.L.door_0) - 0.25 /-/ > &&
					(L.L.door_1) (L.L.door_0) - 0.25 < &&
					(L.L.door_0) 0.15 > &&
					{if}
						(L.L.door0_warten) 1 =
						{if}
							0 (S.L.doorSpeed_0)
							0.20 (S.L.door_0)
						{else}
							(L.L.door_0) 0.25 >
							{if}
								l0 /-/ (L.L.doorMaxSpeed_0) <
								{if}
									(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0)
								{else}
									(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0)
								{endif}
								(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
							{else}
								(L.L.door0_umkehr) 1 =
								{if}
									0.1 (S.L.doorMaxSpeed_0)
									(L.L.doorSpeed_0) (L.L.doorMaxSpeed_0) <
									{if}
										(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0)
									{else}
										(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0)
									{endif}
										(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * *  + (S.L.door_0)
										(L.L.door_0) 0.20 >
										{if}
											1 (S.L.door0_warten)
										{endif}
								{else}
									0.2 (S.L.doorMaxSpeed_0)
									l0 /-/ (L.L.doorMaxSpeed_0) <
									{if}
										(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0)
									{else}
										(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0)
									{endif}
										(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
										(L.L.door_0) 0.18 <
										{if}
											1 (S.L.door0_umkehr)
										{endif}
								{endif}
							{endif}
						{endif}
					{else}
						(L.L.door_0) (F.L.door_0_cls_speed) (S.L.doorMaxSpeed_0)
						l0 /-/ (L.L.doorMaxSpeed_0) <
						{if}
							(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0)
						{else}
							(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0)
						{endif}
							(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
					{endif}
		
				{else}
					l0 /-/ (L.L.doorMaxSpeed_0) <
					{if}
						(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0)
					{else}
						(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0)
					{endif}
					(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
				{endif}
			{else}
				(L.L.doorSpeed_0) abs 0.05 > (L.L.door_0) 1 < || (L.L.doorTarget_0) &&
				{if}
					l0 (L.L.doorMaxSpeed_0) <
					{if}
						(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * + (S.L.doorSpeed_0) 
					{else}
						(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.S.Timegap) * - (S.L.doorSpeed_0) 
					{endif}

'Falls die T�r durch den anderen Fl�gel blockiert wird, geht sie nur gaaanz langsam auf:
					(L.L.door_1) (L.L.door_0) < (L.L.door0_physblock) &&
					{if}
						(C.L.door_blocking_speed) (S.L.doorSpeed_0)
						(T.L.ev_doortriggeropen_0)
					{endif}

					(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
				{else}
					0 (S.L.doorSpeed_0)
				{endif}
			{endif}

			{else}
			0 (S.L.doorSpeed_0)
			{endif}
'Pneumatisch: .................................
		{else}
			(L.L.doorTarget_0) ! (L.L.doorSpeed_0) s0 abs 0.05 > (L.L.door_0) 0 > || (L.L.doorDragAcc_0) 0 = ! || &&  (L.L.door_0_locked) ! &&
			{if}
				(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.L.door_pressure_close_0) * (L.L.doorDragAcc_0) - (L.S.Timegap) * - 
					(L.L.doorDamper_0) (L.L.doorDamper_0_kennwert) (L.S.Timegap) * * -
					(S.L.doorSpeed_0)
				(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
			{else}
				(L.L.doorSpeed_0) abs 0.05 > (L.L.door_0) 1 < || (L.L.doorDragAcc_0) 0 = ! || (L.L.doorTarget_0) && (L.L.door_0_locked) ! &&
				{if}
					(L.L.doorSpeed_0) (L.L.doorAcc_0) (L.L.door_pressure_open_0) * (L.L.doorDragAcc_0) + (L.S.Timegap) * +
						(L.L.doorDamper_0) (L.L.doorDamper_0_kennwert) (L.S.Timegap) * * -
						(S.L.doorSpeed_0) 

'Falls die T�r durch den anderen Fl�gel blockiert wird, geht sie nur gaaanz langsam auf:
					(L.L.door_1) (L.L.door_0) < (L.L.door0_physblock) &&
					{if}
						(C.L.door_blocking_speed) (S.L.doorSpeed_0)
					{endif}

					(L.L.door_0) (L.L.doorSpeed_0) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_0)
				{else}
					0 (S.L.doorSpeed_0)
				{endif}
			{endif}
		{endif}

		(L.L.door_0) 1 >
		{if}
			(T.L.ev_doorhitopen_0)
			1 (S.L.door_0)
			(L.L.doorSpeed_0) /-/ (L.L.doorRefl_0) * (S.L.doorSpeed_0)
		{else}
			(L.L.door_0) 0 <
			{if}
				(T.L.ev_doorhitclose_0)
				0 (S.L.door_0)
				(L.L.doorSpeed_0) /-/ (L.L.doorRefl_0) * (S.L.doorSpeed_0)
			{endif}
		{endif}
{end}

{macro:Door1_Calc}

 	(L.L.door_0) (F.L.door_first) (S.L.door_1)
	
{end}

'###############################################################################################
' Door Calc T�renpaar 2
'###############################################################################################


{macro:Door2_Calc}

	(L.L.door_2) 0 = (L.L.door_3) 0 = && (L.L.rear_door_active) 2 = && {if} 0 (S.L.rear_door_active) {endif}
	(L.L.door_2) 1 = (L.L.rear_door_active) 1 = && {if} 2 (S.L.rear_door_active) {endif}
	(L.L.Velocity) 1 >= {if} 0 (S.L.rear_door_active) {endif}

	(C.L.electric_doors) (L.L.doorEntriegelung_E_active_01) ! &&
	{if}
	    (L.L.doorEntriegelung_doorActive_01)
	    {if}

		(L.L.doortarget_23)
		{if}
			(L.L.door_2) (F.L.door_2_opn_speed) (S.L.doorMaxSpeed_2)
		{else}
			(L.L.door_2) (F.L.door_2_cls_speed) (S.L.doorMaxSpeed_2)
		{endif}

		(C.L.door2_acc) (S.L.doorAcc_2)

		(L.L.doortarget_23) ! (L.L.doorSpeed_2) s0 abs 0.05 > (L.L.door_2) 0 > || && 
		{if}
			(C.L.thinking_doors)
			{if}
				(L.L.doorTarget_1) !
				(L.L.door_3) 0 > &&
				(L.L.door_3) (L.L.door_2) - 0.25 /-/ > &&
				(L.L.door_3) (L.L.door_2) - 0.25 < &&
				(L.L.door_2) 0.15 > &&
				{if}
					(L.L.door2_warten) 1 =
					{if}
						0 (S.L.doorSpeed_2)
						0.20 (S.L.door_2)
					{else}
						(L.L.door_2) 0.25 >
						{if}
							l0 /-/ (L.L.doorMaxSpeed_2) <
							{if}
								(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2)
							{else}
								(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2)
							{endif}
							(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
						{else}
							(L.L.door2_umkehr) 1 =
							{if}
								0.1 (S.L.doorMaxSpeed_2)
								(L.L.doorSpeed_2) (L.L.doorMaxSpeed_2) <
								{if}
									(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2)
								{else}
									(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2)
								{endif}
									(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
									(L.L.door_2) 0.20 >
									{if}
										1 (S.L.door2_warten)
									{endif}
							{else}
								0.2 (S.L.doorMaxSpeed_2)
								l0 /-/ (L.L.doorMaxSpeed_2) <
								{if}
									(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2)
								{else}
									(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2)
								{endif}
									(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
									(L.L.door_2) 0.18 <
									{if}
										1 (S.L.door2_umkehr)
									{endif}
							{endif}
						{endif}
					{endif}
				{else}
					(L.L.door_2) (F.L.door_2_cls_speed) (S.L.doorMaxSpeed_2)
					l0 /-/ (L.L.doorMaxSpeed_2) <
					{if}
						(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2)
					{else}
						(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2)
					{endif}
						(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
				{endif}
	
			{else}
				l0 /-/ (L.L.doorMaxSpeed_2) <
				{if}
					(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2)
				{else}
					(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2)
				{endif}
				(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
			{endif}
		{else}
			(L.L.doorSpeed_2) abs 0.05 > (L.L.door_2) 1 < || (L.L.doortarget_23) &&
			{if}
				l0 (L.L.doorMaxSpeed_2) <
				{if}
					(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * + (S.L.doorSpeed_2) 
				{else}
					(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.S.Timegap) * - (S.L.doorSpeed_2) 
				{endif}

'Falls die T�r durch den anderen Fl�gel blockiert wird, geht sie nur gaaanz langsam auf:
				(L.L.door_3) (L.L.door_2) < (L.L.door2_physblock) &&
				{if}
					(C.L.door_blocking_speed) (S.L.doorSpeed_2)
					(T.L.ev_doortriggeropen_2)
				{endif}

				(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
			{else}
				0 (S.L.doorSpeed_2)
			{endif}
		{endif}

	    {else}
		0 (S.L.doorSpeed_2)
	    {endif}
'Pneumatisch: .................................
	{else}
		(L.L.doortarget_23) ! (L.L.doorSpeed_2) s0 abs 0.05 > (L.L.door_2) 0 > || (L.L.doorDragAcc_2) 0 = ! || &&  (L.L.door_2_locked) ! &&
		{if}
			(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.L.door_pressure_close_2) * (L.L.doorDragAcc_2) - (L.S.Timegap) * - 
				(L.L.doorDamper_2) (L.L.doorDamper_2_kennwert) (L.S.Timegap) * * -
				(S.L.doorSpeed_2)
			(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
		{else}
			(L.L.doorSpeed_2) abs 0.05 > (L.L.door_2) 1 < || (L.L.doorDragAcc_2) 0 = ! || (L.L.doortarget_23) && (L.L.door_2_locked) ! &&
			{if}
				(L.L.doorSpeed_2) (L.L.doorAcc_2) (L.L.door_pressure_open_2) * (L.L.doorDragAcc_2) + (L.S.Timegap) * +
					(L.L.doorDamper_2) (L.L.doorDamper_2_kennwert) (L.S.Timegap) * * -
					(S.L.doorSpeed_2) 

'Falls die T�r durch den anderen Fl�gel blockiert wird, geht sie nur gaaanz langsam auf:
				(L.L.door_3) (L.L.door_2) < (L.L.door2_physblock) &&
				{if}
					(C.L.door_blocking_speed) (S.L.doorSpeed_2)
				{endif}

				(L.L.door_2) (L.L.doorSpeed_2) (L.S.Timegap) (C.L.door_overlap_delay) * * + (S.L.door_2)
			{else}
				0 (S.L.doorSpeed_2)
			{endif}
		{endif}
	{endif}

	(L.L.door_2) 1 >
	{if}
		(T.L.ev_doorhitopen_2)
		1 (S.L.door_2)
		(L.L.doorSpeed_2) /-/ (L.L.doorRefl_2) * (S.L.doorSpeed_2)
	{else}
		(L.L.door_2) 0 <
		{if}
			(T.L.ev_doorhitclose_2)
			0 (S.L.door_2)
			(L.L.doorSpeed_2) /-/ (L.L.doorRefl_2) * (S.L.doorSpeed_2)
		{endif}
	{endif}
{end}

{macro:Door3_Calc}

	(L.L.door_2) (F.L.door_first) (S.L.door_3)
	
{end}

'###############################################################################################
' Hintert�rautomatik
'###############################################################################################


{macro:DoorAft_Open}

		(L.L.doorTarget_23) !
		{if}
			(T.L.ev_doortriggeropen_2)
			1 (S.L.doorTarget_23) (S.L.rear_door_active)
			0 (S.L.tuer3_piep)
		{endif}
		0 (S.L.doorAftLastOpen)		

{end}

{macro:DoorAftCalc}


'	(L.L.knickschutz_aktiv) ! s0
'	{if}
'		l0
'		(L.L.door_2) 0 = &&
'		(L.L.door_3) 1 = || &&
'		s0
'	{endif}


	(L.L.cp_switch_main_rot_set) 0.33 >=
	{if}
		
		16 (M.V.GetHumanCountOnPathLink) ! 17 (M.V.GetHumanCountOnPathLink) ! &&
			{if}
				(L.L.doorAftLastOpen) (L.S.Timegap) + (S.L.doorAftLastOpen)
			{else}
				0 (S.L.doorAftLastOpen)
			{endif}
		

		(L.L.doorTarget_23)
		(L.L.doorAftLastOpen) (C.L.doorAftOpenTime) > &&
		16 (M.V.GetHumanCountOnPathLink) ! &&
		17 (M.V.GetHumanCountOnPathLink) ! &&
		{if}
			(T.L.ev_doortriggerclose_2)
			0 (S.L.doorTarget_23) 
		{endif}
	{endif}
{end}


'###############################################################################################
' Door Calc T�renpaar 3
'###############################################################################################

{macro:Door4_Calc}
	(C.L.electric_doors) (L.L.doorEntriegelung_E_active_45) ! &&
	{if}
	    (L.L.doorEntriegelung_doorActive_45)
	    {if}
		(L.L.doorTarget_45)
		{if}
			(L.L.door_4) (F.L.door_4_opn_speed) (S.L.doorMaxSpeed_4)
		{else}
			(L.L.door_4) (F.L.door_4_cls_speed) (S.L.doorMaxSpeed_4)
		{endif}

		(C.L.door4_acc) (S.L.doorAcc_4)

		(L.L.doorTarget_45) ! (L.L.doorSpeed_4) s0 abs 0.05 > (L.L.door_4) 0 > || && 
		{if}
			l0 /-/ (L.L.doorMaxSpeed_4) <
			{if}
				(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.S.Timegap) * - (S.L.doorSpeed_4)
			{else}
				(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.S.Timegap) * + (S.L.doorSpeed_4)
			{endif}
			(L.L.door_4) (L.L.doorSpeed_4) (L.S.Timegap) * + (S.L.door_4)
		{else}
			(L.L.doorSpeed_4) abs 0.05 > (L.L.door_4) 1 < || (L.L.doorTarget_45) &&
			{if}
				l0 (L.L.doorMaxSpeed_4) <
				{if}
					(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.S.Timegap) * + (S.L.doorSpeed_4) 
				{else}
					(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.S.Timegap) * - (S.L.doorSpeed_4) 
				{endif}
				(L.L.door_4) (L.L.doorSpeed_4) (L.S.Timegap) * + (S.L.door_4)
			{else}
				0 (S.L.doorSpeed_4)
			{endif}
		{endif}
	
	    {else}
		0 (S.L.doorSpeed_4)
	    {endif}
'Pneumatisch: .................................
	{else}
		(L.L.doorTarget_45) ! (L.L.doorSpeed_4) s0 abs 0.05 > (L.L.door_4) 0 > || (L.L.doorDragAcc_4) 0 = ! || && (L.L.door_4_locked) ! &&
		{if}
			(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.L.door_pressure_close_4) (L.L.doorDragAcc_4) - * (L.S.Timegap) * -
				(L.L.doorDamper_4) (L.L.doorDamper_4_kennwert) (L.S.Timegap) * * -
				(S.L.doorSpeed_4)
			(L.L.door_4) (L.L.doorSpeed_4) (L.S.Timegap) * + (S.L.door_4)
		{else}
			(L.L.doorSpeed_4) abs 0.05 > (L.L.door_4) 1 < || (L.L.doorDragAcc_4) 0 = ! || (L.L.doorTarget_45) && (L.L.door_4_locked) ! &&
			{if}
				(L.L.doorSpeed_4) (L.L.doorAcc_4) (L.L.door_pressure_open_4) (L.L.doorDragAcc_4) + * (L.S.Timegap) * +
					(L.L.doorDamper_4) (L.L.doorDamper_4_kennwert) (L.S.Timegap) * * -
					(S.L.doorSpeed_4) 
				(L.L.door_4) (L.L.doorSpeed_4) (L.S.Timegap) * + (S.L.door_4)
			{else}
				0 (S.L.doorSpeed_4)
			{endif}
		{endif}
	{endif}

	(L.L.door_4) 1 >
	{if}
		(T.L.ev_doorhitopen_4)
		1 (S.L.door_4)
		(L.L.doorSpeed_4) /-/ (L.L.doorRefl_4) * (S.L.doorSpeed_4)
	{else}
		(L.L.door_4) 0 <
		{if}
			(T.L.ev_doorhitclose_4)
			0 (S.L.door_4)
			(L.L.doorSpeed_4) /-/ (L.L.doorRefl_4) * (S.L.doorSpeed_4)
		{endif}
	{endif}
{end}

{macro:Door5_Calc}
	(C.L.electric_doors) (L.L.doorEntriegelung_E_active_45) ! &&
	{if}
	    (L.L.doorEntriegelung_doorActive_45)
	    {if}
		(L.L.doorTarget_45)
		{if}
			(L.L.door_5) (F.L.door_5_opn_speed) (S.L.doorMaxSpeed_5)
		{else}
			(L.L.door_5) (F.L.door_5_cls_speed) (S.L.doorMaxSpeed_5)
		{endif}

		(C.L.door5_acc) (S.L.doorAcc_5)

		(L.L.doorTarget_45) ! (L.L.doorSpeed_5) s0 abs 0.05 > (L.L.door_5) 0 > || && 
		{if}
			l0 /-/ (L.L.doorMaxSpeed_5) <
			{if}
				(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.S.Timegap) * - (S.L.doorSpeed_5)
			{else}
				(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.S.Timegap) * + (S.L.doorSpeed_5)
			{endif}
			(L.L.door_5) (L.L.doorSpeed_5) (L.S.Timegap) * + (S.L.door_5)
		{else}
			(L.L.doorSpeed_5) abs 0.05 > (L.L.door_5) 1 < || (L.L.doorTarget_45) &&
			{if}
				l0 (L.L.doorMaxSpeed_5) <
				{if}
					(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.S.Timegap) * + (S.L.doorSpeed_5) 
				{else}
					(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.S.Timegap) * - (S.L.doorSpeed_5) 
				{endif}
				(L.L.door_5) (L.L.doorSpeed_5) (L.S.Timegap) * + (S.L.door_5)
			{else}
				0 (S.L.doorSpeed_5)
			{endif}
		{endif}
		
	    {else}
		0 (S.L.doorSpeed_5)
	    {endif}
'Pneumatisch: .................................
	{else}
		(L.L.doorTarget_45) ! (L.L.doorSpeed_5) s0 abs 0.05 > (L.L.door_5) 0 > || (L.L.doorDragAcc_5) 0 = ! || && (L.L.door_5_locked) ! &&
		{if}
			(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.L.door_pressure_close_5) (L.L.doorDragAcc_5) - * (L.S.Timegap) * -
				(L.L.doorDamper_5) (L.L.doorDamper_5_kennwert) (L.S.Timegap) * * -
				(S.L.doorSpeed_5)
			(L.L.door_5) (L.L.doorSpeed_5) (L.S.Timegap) * + (S.L.door_5)
		{else}
			(L.L.doorSpeed_5) abs 0.05 > (L.L.door_5) 1 < || (L.L.doorDragAcc_5) 0 = ! || (L.L.doorTarget_45) && (L.L.door_5_locked) ! &&
			{if}
				(L.L.doorSpeed_5) (L.L.doorAcc_5) (L.L.door_pressure_open_5) (L.L.doorDragAcc_5) + * (L.S.Timegap) * +
					(L.L.doorDamper_5) (L.L.doorDamper_5_kennwert) (L.S.Timegap) * * -
					(S.L.doorSpeed_5) 
				(L.L.door_5) (L.L.doorSpeed_5) (L.S.Timegap) * + (S.L.door_5)
			{else}
				0 (S.L.doorSpeed_5)
			{endif}
		{endif}
	{endif}

	(L.L.door_5) 1 >
	{if}
		(T.L.ev_doorhitopen_5)
		1 (S.L.door_5)
		(L.L.doorSpeed_5) /-/ (L.L.doorRefl_5) * (S.L.doorSpeed_5)
	{else}
		(L.L.door_5) 0 <
		{if}
			(T.L.ev_doorhitclose_5)
			0 (S.L.door_5)
			(L.L.doorSpeed_5) /-/ (L.L.doorRefl_5) * (S.L.doorSpeed_5)
		{endif}
	{endif}

{end}

'###############################################################################################

{macro:trg_bus_doorfront0}

	(L.L.doorEntriegelung_E_active_01) (C.L.electric_doors) && !
	{if}
		(L.L.doorTarget_0) ! (S.L.doorTarget_0) 
		{if}
			(T.L.ev_doortriggeropen_0)
		{else}
			(T.L.ev_doortriggerclose_0)
		{endif}
		(C.L.door_druckluft)
		{if}
			(L.L.doorEntriegelung_doorActive_01) -1 =
			{if}
				0 (S.L.doorEntriegelung_doorActive_01)
			{else}
				1 (S.L.doorEntriegelung_doorActive_01)
			{endif}	
			(L.L.bremse_p_Tank04) 100000 - 0.96 * 100000 + (S.L.bremse_p_Tank04)
		{else}
			1 (S.L.doorEntriegelung_doorActive_01)
		{endif}
	{endif}
{end}

{macro:trg_bus_doorfront1}

	(L.L.doorEntriegelung_E_active_01) (C.L.electric_doors) && !
	{if}
		(L.L.doorTarget_1) ! (S.L.doorTarget_1) 
		{if}
			(T.L.ev_doortriggeropen_1)
		{else}
			(T.L.ev_doortriggerclose_1)
		{endif}	
		(C.L.door_druckluft)
		{if}
			(L.L.doorEntriegelung_doorActive_01) -1 =
			{if}
				0 (S.L.doorEntriegelung_doorActive_01)
			{else}
				1 (S.L.doorEntriegelung_doorActive_01)
			{endif}	
			(L.L.bremse_p_Tank04) 100000 - 0.96 * 100000 + (S.L.bremse_p_Tank04)
		{else}
			1 (S.L.doorEntriegelung_doorActive_01)
		{endif}
	{endif}
{end}


{macro:AI_doorback}
	(L.L.door_2) 0.05 <
		{if}
			(L.L.cp_stopbrake_targeton) (C.L.door_needs_stopbrakeswitch) &&
			(L.L.bremse_halte) (C.L.door_needs_stopbrake) && ||
			(C.L.door_needs_stopbrake) (C.L.door_needs_stopbrakeswitch) || ! ||
			(L.L.cp_switch_main_rot_set) 0.33 >= &&
			(L.L.doorEntriegelung_23) ! &&
			(L.L.Velocity) (C.L.doors_maxvspeed) < && 
			(L.L.door_rampe) 0 = &&
			(L.L.bremse_p_Tank04) 500000 > &&	 
				{if}

						(M.L.trg_bus_dooraft)
						0 (S.L.doorEntriegelung_23wait)
						
				{endif}	
		{endif}

	(L.L.door_2) 0.05 >
		{if}
			(L.L.cp_switch_main_rot_set) 0.33 >=
				{if}
					
						(M.L.trg_bus_dooraft)
						(L.L.globaltimer) (S.L.door_time)

						0 (S.L.door_memory2)
				{endif}		
		{endif}
{end}


{macro:trg_bus_dooraft}

	(L.L.doorEntriegelung_E_active_23) (C.L.electric_doors) && !
	{if}
		(L.L.doorTarget_23) ! (S.L.doorTarget_23) 
		{if}
			(T.L.ev_doortriggeropen_2)
			1 (S.L.rear_door_active)
		{else}
			(T.L.ev_doortriggerclose_2)
		{endif}
		(C.L.door_druckluft)
		{if}
			(L.L.doorEntriegelung_doorActive_23) -1 =
			{if}
				0 (S.L.doorEntriegelung_doorActive_23)
			{endif}
			(L.L.bremse_p_Tank04) 100000 - 0.96 * 100000 + (S.L.bremse_p_Tank04)
		{else}
			1 (S.L.doorEntriegelung_doorActive_23)
		{endif}
	{endif}
{end}



{macro:traegheit}

'Simuliert tr�ges Verhalten (exponentiell)

'Ladekonventionen:
'	Sollwert		l0
'	Istwert			l1
'	Konstante Anlauf	l2 (Einheiten/s)
'	Konstante Ablauf	l3 (Einheiten/s)

'Anlauf oder Auslauf?
	l0 l1 > 
	{if}
		l2 (L.S.Timegap) * 1 min -1 max s4
	{else}
		l3 (L.S.Timegap) * 1 min -1 max s4
	{endif}


'Sollwert:
	l0
'Istwert:
	l1
'Beschleunigung:
	- l4 *
'Addition zum Istwert:
	l1 + s1
{end}